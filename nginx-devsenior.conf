# Detectar HTTPS desde Traefik (X-Forwarded-Proto)
map $http_x_forwarded_proto $custom_scheme {
    default $scheme;
    https https;
}

server {
    listen 80 ipv6only=off;
    server_name _;

    # Enable Server Side Includes (SSI) for HTML includes
    ssi on;
    ssi_silent_errors off;
    ssi_types text/html;

    root /usr/share/nginx/html;
    index index.html index_dev.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve main files
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache";
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # BOSH
    location = /http-bind {
        proxy_pass http://prosody:5280/http-bind;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $http_host;
    }

    # XMPP Websocket
    location = /xmpp-websocket {
        proxy_pass http://prosody:5280/xmpp-websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $remote_addr;
        
        # Extended timeouts para estabilidad de WebSocket
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 90s;
        
        # Keepalive
        keepalive_timeout 3600s;
        
        # Optimización de buffers
        proxy_buffering off;
        proxy_buffer_size 4k;
        
        tcp_nodelay on;
    }

    # Colibri (JVB) Websocket
    location ~ ^/colibri-ws/([a-zA-Z0-9-\._]+)/(.*) {
        proxy_pass http://jvb:9090/colibri-ws/$1/$2;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Extended timeouts para JVB WebSocket
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 90s;
        
        # Optimización
        proxy_buffering off;
        
        tcp_nodelay on;
    }
    
    # Informar a la aplicación que estamos en HTTPS para WebRTC
    add_header X-Forwarded-Proto $custom_scheme;
    proxy_set_header X-Forwarded-Proto $custom_scheme;

    # Disable access to hidden files
    location ~ /\. {
        deny all;
    }
}
